<!DOCTYPE html>
<html>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <head>
        <title>Opal RMS Login Page</title>
        <base href="/orms/">

        <script src="node_modules/angular/angular.min.js"></script>
        <script src="node_modules/angular-cookies/angular-cookies.min.js"></script>

        <noscript>
            <div id="nojavascript">
                <div>
                    This application requires JavaScript for correct operation. Please <a href="https://www.enable-javascript.com/" target="_blank" rel="noreferrer noopener">enable JavaScript</a> and reload the page.
                </div>
            </div>
        </noscript>
    </head>

    <body ng-app="myApp" ng-controller="main">
        <div class="error-wrapper" ng-if="error">
            <div class="error-text">{{error}}</div>
        </div>
    </body>
</html>

<script>
var app = angular.module('myApp', ['ngCookies']);

app.controller('main', function($scope, $http, $cookies, $location, $window, $timeout)
{
    // Check if Django's session cookies already exist (e.g., sessionid and csrftoken) in case
    // user logged in via OpalAdmin.
    // The actual check is performed in PHP: php/api/public/v1/auth/validateSession
    //
    // If the condition is True:
    //     - validate Django's session cookies by making a call to the Django backend;
    //     - if session cookies are valid, create a session in the ORMS backend;
    //     - show area selection modal pop-up dialog;
    // Otherwise user should see login page (e.g., normal logging in workflow).
    validateOpalAdminSession();

    // Check if Django's sessionid and csrftoken cookies are valid and set ORMS cookies.
    async function validateOpalAdminSession() {
        try {
            const response = await $http({
                url: "php/api/public/v1/auth/validateSession",
                method: "GET",
            });

            // Redirect to main page
            $window.location.href = $location.absUrl();
        } catch (error) {
            if (error.status === 403) {
                $timeout(function() {
                    $scope.error = "You do not have permission to access ORMS. Contact the Opal systems administrator.";
                });
            } else if (error.status === 401) {
                $window.location.href = error.data.data;
            } else {
                console.error(`Session validation failed: ${error?.data?.error}`);
            }
        }
    }
});

</script>
