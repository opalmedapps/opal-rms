<!DOCTYPE html>
<html>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <head>
        <title>Opal RMS Login Page</title>
        <base href="/orms/">

        <script src="node_modules/angular/angular.min.js"></script>
        <script src="node_modules/angular-cookies/angular-cookies.min.js"></script>
        <script src="node_modules/angular-animate/angular-animate.min.js"></script>
        <script src="node_modules/angular-aria/angular-aria.min.js"></script>
        <script src="node_modules/angular-material/angular-material.js"></script>

        <link rel="stylesheet" href="node_modules/angular-material/angular-material.min.css">
        <link rel="stylesheet" href="auth/custom.css">

        <noscript>
            <div id="nojavascript">
                <div>
                    This application requires JavaScript for correct operation. Please <a href="https://www.enable-javascript.com/" target="_blank" rel="noreferrer noopener">enable JavaScript</a> and reload the page.
                </div>
            </div>
        </noscript>
    </head>

    <body ng-app="myApp" ng-controller="main">
        <div ng-if="showSpecialitySelection" style="width:100%;height:100%;background-color: white;position: absolute;z-index: 1;"></div>

        <div class="body-login">
            <div class="pageHeader"></div>
            <div class="logo-desc">
                <img src="images/Opal_RMS_logo.png" width="40%">
            </div>

            <form class="login-form" ng-submit="authenticateUser()">
                <div style="width: 200%"><h1 style="font-size: 32px">Login to ORMS to manage your clinic</h1></div>
                <fieldset class="field-holder">
                    <input class="credentials" type="text" ng-model="username" name="username" placeholder="MUHC AD Username" autofocus required />
                    <input class="credentials" type="password" ng-model="password" placeholder="Password" required />

                    <div class="error-wrapper">
                        <div class="error-text">{{error}}</div>
                    </div>
                    <div class="submit-wrapper">
                        <input type="submit" class="login-submit" title="Confirm" value="Log in" />
                        <div class="submit-icon"><img src="images/confirm-white.png" /></div>
                    </div>
                </fieldset>
                <div class="help-container">
                    <div class="help-trigger">Need help?</div>
                    <div class="help-text">Please contact the help desk at extension x48484</div>
                </div>

            </form>
        </div>
    </body>
</html>

<script>
var app = angular.module('myApp',['ngCookies','ngMaterial']);

app.controller('main', function($scope,$http,$mdDialog,$cookies,$location,$window)
{
    $http({
        url: "php/api/public/v1/hospital/getHubs",
        method: "POST",
        data: null
    })
    .then( x => {$scope.specialityGroups = x.data.data;})

    $http({
        url: "php/api/public/v1/auth/validateSession",
        method: "GET"
    })
    .then(v => processAuthentication(v.data.data))
    .catch(err => {
        $error = err?.data?.error ? err.data.error : "Authentication failed";
        console.log($error);
    });

    $scope.authenticateUser = function()
    {
        $scope.error = "";
        $http({
                url: "php/api/public/v1/auth/createSession",
                method: "POST",
                data: {
                    "username": $scope.username,
                    "password": $scope.password
                }
        })
        .then(r => processAuthentication(r.data.data))
        .catch(err => {
                $scope.error = err?.data?.error ? err.data.error : "Authentication failed";
                $scope.password = "";
        });
    };

    function processAuthentication(authData)
    {
        $scope.showSpecialitySelection = true;

        let answer = $mdDialog.confirm(
        {
            escapeToClose: false,
            template: specialityTemplate,
            locals: {
                specialityGroups: $scope.specialityGroups
            },
            controller: function($scope,specialityGroups)
            {
                $scope.specialityGroups = specialityGroups;
                $scope.complete = function(option)
                {
                    $mdDialog.hide(option);
                }
            }
        })
        .ariaLabel('Area Dialog')
        .hasBackdrop(false);

        $mdDialog.show(answer).then(function(result)
        {
            if(result.length !== 1)
            {
                let answer = $mdDialog.confirm(
                {
                    escapeToClose: false,
                    template: hubTemplate,
                    locals: {
                        hubs: result
                    },
                    controller: function($scope,hubs)
                    {
                        $scope.hubs = hubs;
                        $scope.complete = function(option)
                        {
                            $mdDialog.hide(option);
                        }
                    }
                })
                .ariaLabel('Area Dialog')
                .hasBackdrop(false);

                $mdDialog.show(answer).then(function(resultHub)
                {
                    createCookiesAndRedirect(authData,resultHub);
                });
            }
            else
            {
                createCookiesAndRedirect(authData,result[0]);
            }
        });
    }

    function createCookiesAndRedirect(authData,hubData)
    {
        $cookies.put("specialityGroupId",hubData["specialityGroupId"],{path: "/"});
        $cookies.put("specialityGroupName",hubData["specialityGroupName"],{path: "/"});
        $cookies.put("clinicHubId",hubData["clinicHubId"],{path: "/"});
        $cookies.put("clinicHubName",hubData["clinicHubName"],{path: "/"});
        $cookies.put("hospitalCode",hubData["hospitalCode"],{path: "/"});
        $cookies.put("csrftoken",authData["csrftoken"]["value"], authData["csrftoken"]["params"]);
        $cookies.put("sessionid",authData["sessionid"]["value"], authData["sessionid"]["params"]);
        $cookies.put(authData["name"],authData["key"],{path: "/"});
        $window.location.href = $location.absUrl();
    }
});

var specialityTemplate = `
    <md-dialog-content class="md-dialog-content" role="document" tabindex="-1" id="dialogContent_0">
        <h2 class="md-title ng-binding">Connect to a Clinical Area</h2>
        <div ng-if="::!dialog.mdHtmlContent" class="md-dialog-content-body ng-scope">
            <span style="display:flex;justify-content:center;">
                <md-button ng-repeat="(key,spec) in specialityGroups" md-no-ink="" class="md-raised md-primary" ng-click="complete(spec)">{{key}}</md-button>
            </span>
        </div>
    </md-dialog-content>
`;

var hubTemplate = `
    <md-dialog-content class="md-dialog-content" role="document" tabindex="-1" id="dialogContent_0">
        <h2 class="md-title ng-binding">Select a TV Hub</h2>
        <div ng-if="::!dialog.mdHtmlContent" class="md-dialog-content-body ng-scope">
            <span style="display:flex;justify-content:center;">
                <md-button ng-repeat="hub in hubs" md-no-ink="" class="md-raised md-primary" ng-click="complete(hub)">{{hub.clinicHubName}}</md-button>
            </span>
        </div>
    </md-dialog-content>
`;

</script>
