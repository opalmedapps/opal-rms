# SPDX-FileCopyrightText: Copyright (C) 2021 Opal Health Informatics Group at the Research Institute of the McGill University Health Centre <john.kildea@mcgill.ca>
#
# SPDX-License-Identifier: AGPL-3.0-or-later

openapi: 3.0.2
info:
  title: ORMS Public Api
  version: 0.2.0
servers:
  - url: /php/api/public/v1

tags:
  - name: appointment
    description: Endpoints related to appointments
  - name: auth
    description: Endpoints related to api authorization
  - name: hospital
    description: Endpoints related to waiting room configuration within a hospital
  - name: patient
    description: Endpoints related to patient demographics, diagnoses, and hospital identifiers
  - name: sms
    description: Endpoints related to SMS messaging support for patients
  - name: institution integration
    description: Endpoints for integrating the Open Opal solution with an institution

paths:
  /appointment/insertOrUpdateAppointment:
    post:
      summary: Create a new appointment, or update an existing one
      description: Imports or updates appointments from (external) source systems into ORMS
      tags:
        - appointment
        - institution integration
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                appointmentCode:
                  description: Appointment code
                  type: string
                clinics:
                  description: List of clinics attached to be appointment
                  type: array
                  minItems: 1
                  items:
                    type: object
                    properties:
                      clinicCode:
                        description: Clinic code
                        type: string
                      clinicDescription:
                        description: Clinic code description
                        type: string
                    required:
                      - clinicCode
                      - clinicDescription
                creationDatetime:
                  description: Creation date of the appointment
                  type: string
                  pattern: '^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$'
                mrn:
                  description: Medical record number
                  type: string
                scheduledDatetime:
                  description: Scheduled date of the appointment
                  type: string
                  pattern: '^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$'
                site:
                  description: Hospital site
                  type: string
                sourceId:
                  description: Id of the appointment in the source system
                  type: string
                sourceSystem:
                  description: External system from which the appointment originates
                  type: string
                specialityGroupCode:
                  description: ORMS defined speciality group code
                  type: string
                status:
                  description: Status of the appointment, determined by the HL7 SIU code
                  type: string
                  enum:
                    - Open
                    - Completed
                    - Cancelled
                    - Deleted
                visitStatus:
                  description: Status of the visit in the source system
                  type: string
                  nullable: true
              required:
                - appointmentCode
                - clinics
                - creationDatetime
                - mrn
                - scheduledDatetime
                - site
                - sourceId
                - sourceSystem
                - specialityGroupCode
                - status
      responses:
        200:
          $ref: '#/components/responses/200'
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'
  /appointment/insertClinicResource:
    post:
      summary: Create a new clinic resource, or update an existing one
      description: Imports or updates clinic resources from (external) source systems into ORMS
      tags:
        - appointment
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                appointmentCode:
                  description: Appointment code
                  type: string
                clinics:
                  description: List of clinics attached to be appointment
                  type: array
                  minItems: 1
                  items:
                    type: object
                    properties:
                      clinicCode:
                        description: Clinic code
                        type: string
                      clinicDescription:
                        description: Clinic code description
                        type: string
                    required:
                      - clinicCode
                      - clinicDescription
                sourceSystem:
                  description: External system from which the appointment originates
                  type: string
                specialityGroupCode:
                  description: ORMS defined speciality group code
                  type: string
              required:
                - appointmentCode
                - clinics
                - sourceSystem
                - specialityGroupCode
      responses:
        200:
          $ref: '#/components/responses/200'
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /auth/validateSession:
    get:
      summary: Validate user session
      description: Validate user session
      tags:
        - auth
        - institution integration    
      responses:
        200:
          $ref: '#/components/responses/200'
        400:
          $ref: '#/components/responses/400'
        401:
          $ref: '#/components/responses/401' 
        403:
          $ref: '#/components/responses/403' 
        500:
          $ref: '#/components/responses/500'

  /auth/removeSession:
    post:
      summary: Remove user session
      description: Remove user session
      tags:
        - auth
                    
      responses:
        200:
          $ref: '#/components/responses/200'
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /auth/createSession:
    post:
      summary: Create a user session
      description: Create a user session by authenticating with a user's hospital AD account
      tags:
        - auth
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  description: Hospital AD username
                  type: string
                password:
                  description: Hospital AD password
                  type: string
              required:
                - username
                - password
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/SuccessProperty'
                  data:
                    properties:
                      name:
                        description: Name of the auth cookie
                        type: string
                      key:
                        description: Authentication cookie key
                        type: string
        400:
          $ref: '#/components/responses/400'
        403:
          $ref: '#/components/responses/403' 
        406:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /hospital/getHubs:
    post:
      summary: Get a list of room hubs
      description: Get a list of room hubs defined in ORMS
      tags:
        - hospital
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/SuccessProperty'
                  data:
                    description: A list of hubs
                    type: array
                    items:
                      additionalProperties:
                        type: array
                        items:
                          type: object
                          properties:
                            clinicHubId:
                              description: Hub id
                              type: integer
                            clinicHubName:
                              description: Hub name
                              type: string
                            hospitalCode:
                              description: Hospital code
                              type: string
                            specialityGroupId:
                              description: Speciality group id
                              type: integer
                            specialityGroupName:
                              description: Speciality group name
                              type: string
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /hospital/getSpecialityGroups:
    post:
      summary: Get a list of all speciality groups
      description: Get a list of all the speciality group in the hospital
      tags:
        - hospital
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/SuccessProperty'
                  data:
                    description: List of speciality groups
                    type: array
                    items:
                      type: object
                      properties:
                        specialityCode:
                          description: Speciality group code
                          type: string
                        specialityName:
                          description: Speciality group name
                          type: string
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /patient/checkIfInsuranceIsValid:
    post:
      summary: Checks if an insurance is valid
      description: Verifies if an insurance number format is valid for a given insurance type
      tags:
        - patient
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                insuranceNumber:
                  description: Value of the insurance (not necessarily a number)
                  type: string
                type:
                  description: Type of the insurance
                  type: string
              required:
                - insuranceNumber
                - type
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/SuccessProperty'
                  data:
                    description: True if the insurance is valid
                    type: boolean
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /patient/checkIfPatientExists:
    post:
      summary: Checks if a patient exists in ORMS
      description: Matches a patient in the ORMS database using an mrn and site
      tags:
        - patient
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                mrn:
                  description: Medical record number
                  type: string
                site:
                  description: Hospital site
                  type: string
              required:
                - mrn
                - site
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/SuccessProperty'
                  data:
                    description: True if the patient exists
                    type: boolean
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /patient/checkInToLocation:
    post:
      summary: Check a patient in for their appointments
      description: Updates the patient's location in the hospital for all their appointments of the day
      tags:
        - patient
        - institution integration
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                mrn:
                  description: Medical record number
                  type: string
                site:
                  description: Hospital site
                  type: string
                room:
                  description: Hospital location
                  type: string
              required:
                - mrn
                - site
                - room
      responses:
        200:
          $ref: '#/components/responses/200'
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /patient/deleteRamqs:
    post:
      summary: Deletes ramqs for a patient
      description: Sets all ramq insurance numbers to inactive for a patient
      tags:
        - patient
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                mrn:
                  description: Medical record number
                  type: string
                site:
                  description: Hospital site
                  type: string
                insuranceType:
                  description: Type of insurance
                  type: string
              required:
                - mrn
                - site
      responses:
        200:
          $ref: '#/components/responses/200'
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /patient/getDiagnoses:
    post:
      summary: Retrieve a patient's diagnoses
      description: Gets all diagnoses in a patient's profile in a format usefult for the Opal Interface Engine
      tags:
        - patient
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                mrn:
                  description: Medical record number
                  type: string
                site:
                    description: Hospital site
                    type: string
              required:
                - mrn
                - site
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/SuccessProperty'
                  data:
                    description: A list of diagnoses
                    type: array
                    items:
                      properties:
                        mrn:
                          description: Medical record number
                          type: string
                        site:
                          description: Hospital site
                          type: string
                        source:
                          description: Source system
                          type: string
                          enum: ["ORMS"]
                        rowId:
                          description: ORMS internal id
                          type: integer
                        externalId:
                          description: ICD system
                          type: string
                          enum: ["ICD-10"]
                        code:
                          description: Diagnosis code
                          type: string
                        creationDate:
                          description: Diagnosis date
                          type: string
                        descriptionEn:
                          description: English code description
                          type: string
                        descriptionFr:
                          description: French code description
                          type: string
                          enum: [""]
                        status:
                          description: Diagnosis status
                          type: string
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /patient/mergeMrn:
    post:
      summary: Merge a patient's mrn
      description: Disable a patient's mrn. Usually the mrn has been "merged" into another one of the patient's mrns.
      tags:
        - patient
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                mrn:
                  description: Medical record number
                  type: string
                site:
                    description: Hospital site
                    type: string
              required:
                - mrn
                - site
      responses:
        200:
          $ref: '#/components/responses/200'
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /patient/notifyNewQuestionnaireResponse:
    post:
      summary: Notify ORMS about new questionnaire answers
      description: Notify ORMS about new questionnaires answered in Opal
      tags:
        - patient
      responses:
        200:
          $ref: '#/components/responses/200'
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /patient/updateOpalStatus:
    post:
      summary: Update a patient's opal status
      description: Mark a patient as registered for Opal or not
      tags:
        - patient
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                mrn:
                  description: Medical record number
                  type: string
                site:
                  description: Hospital site
                  type: string
                opalStatus:
                  description: Whether a patient is registered for Opal or not
                  type: integer
                  enum:
                    - 0
                    - 1
              required:
                - mrn
                - site
                - opalStatus
      responses:
        200:
          $ref: '#/components/responses/200'
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /patient/updatePatientDemographics:
    post:
      summary: Update patient demographic information
      description: Update a patient's record in ORMS with demograhic information from a hospital source system
      tags:
        - patient
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PatientObject'
      responses:
        200:
          $ref: '#/components/responses/200'
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /sms/smsAppointment/getSmsAppointments:
    post:
      summary: Get a list of all the sms appointments
      description: Get a list of all the sms appointments in the system
      tags:
        - sms
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/SuccessProperty'
                  data:
                    description: A list of sms appointments
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          description: Sms appointment id
                          type: integer
                        type:
                          description: Sms appointment type
                          type: string
                          nullable: true
                        appointmentCode:
                          description: Appointment code
                          type: string
                        resourceCode:
                          description: Resource code
                          type: string
                        resourceName:
                          description: Resource name
                          type: string
                        active:
                          description: Status of the sms appointment
                          type: integer
                          enum:
                            - 0
                            - 1
                        speciality:
                          description: Speciality group name
                          type: string
                        specialityCode:
                          description: Speciality group code
                          type: string
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /sms/smsAppointment/updateSmsAppointment:
    post:
      summary: Updates an sms appointment entry
      description: Updates the type and status of an sms appointment entry
      tags:
        - sms
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                id:
                  description: Id of the sms appointment
                  type: integer
                active:
                  description: Status of the sms appointment
                  type: integer
                  enum:
                    - 0
                    - 1
                type:
                  description: Type of the sms appointment
                  type: string
                  nullable: true
              required:
                - id
                - active
                - type
      responses:
        200:
          $ref: '#/components/responses/200'
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /sms/smsMessage/getMessages:
    post:
      summary: Get a list of sms messages
      description: Get a list of sms messages sorted by event
      tags:
        - sms
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                specialityCode:
                  description: Speciality group code
                  type: string
                type:
                  description: Message type
                  type: string
              required:
                - specialityCode
                - type
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/SuccessProperty'
                  data:
                    description: A list of Sms message event
                    type: array
                    items:
                      type: object
                      properties:
                        event:
                          description: Selected message event
                          type: string
                        language:
                          description: Selected message language
                          type: string
                        messageId:
                          description: Sms message id
                          type: integer
                        smsMessage:
                          description: Sms message content
                          type: string
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /sms/smsMessage/getTypes:
    post:
      summary: Get a list of message types
      description: Get a list of sms message types for a speciality group
      tags:
        - sms
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                specialityCode:
                  description: Speciality group code
                  type: string
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/SuccessProperty'
                  data:
                    description: A list of message types
                    type: array
                    items:
                      type: string
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

  /sms/smsMessage/updateMessage:
    post:
      summary: Update the content of an sms message
      description: Update the content of an sms message
      tags:
        - sms
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                messageId:
                  description: Sms message id
                  type: integer
                smsMessage:
                  description: Sms message content
                  type: string
              required:
                - messageId
                - smsMessage
      responses:
        200:
          $ref: '#/components/responses/200'
        400:
          $ref: '#/components/responses/400'
        500:
          $ref: '#/components/responses/500'

components:
  responses:
    200:
      description: Success
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SuccessObject'
    400:
      description: Input error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorObject'
    401:
      description: Authentication error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorObject'
    403:
      description: Authorization error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorObject'
    500:
      description: Server error

  schemas:
    SuccessObject:
      type: object
      properties:
        status:
          $ref: '#/components/schemas/SuccessProperty'
    ErrorObject:
      type: object
      properties:
        status:
          description: Status of the api call
          type: string
          enum:
            - Error
        error:
          description: Description of the error, if any
          type: string
    SuccessProperty:
      description: Status of the api call
      type: string
      enum:
        - Success
    MrnObject:
      type: object
      properties:
        mrn:
          description: Medical record number
          type: string
        site:
          description: Hospital site
          type: string
        active:
          description: Status of the mrn
          type: boolean
    PatientObject:
      type: object
      properties:
        firstName:
          description: The patient's first name
          type: string
        lastName:
          description: The patient's last name
          type: string
        dateOfBirth:
          description: The patient's date of birth
          type: string
          pattern: '^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$'
        sex:
          description: The patient's sex
          type: string
        mrns:
          description: List of all mrns of the patient
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/MrnObject'
        insurances:
          description: List of all insurances of the patient
          type: array
          items:
            type: object
            properties:
              insuranceNumber:
                description: Value of the insurance (not necessarily a number)
                type: string
              expirationDate:
                description: Expiration date of the insurance
                type: string
                pattern: '^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$'
              type:
                description: Type of the insurance
                type: string
              active:
                description: Status of the insurance
                type: boolean
      required:
        - firstName
        - lastName
        - dateOfBirth
        - sex
        - mrns
