<html>

<head>
    <title>Chemotherapy Durations Report</title>
    <base href="/orms/">
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="node_modules/jquery-ui-dist/jquery-ui.min.js"></script>
    <script src="node_modules/datatables.net/js/jquery.dataTables.js"></script>
    <script src="node_modules/angular/angular.min.js"></script>
    <script src="node_modules/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="node_modules/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="node_modules/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="node_modules/angular-datatables/dist/angular-datatables.min.js"></script>
    <script src="node_modules/angular-datatables/dist/plugins/buttons/angular-datatables.buttons.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="node_modules/ui-bootstrap4/dist//ui-bootstrap-tpls.js"></script>
    <script src="node_modules/angular-bowser/src/angular-bowser.js"></script>
    
    <link media="all" type="text/css" rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link media="all" type="text/css" rel="stylesheet"
    href="node_modules/datatables.net-dt/css/jquery.dataTables.css">
    <link media="all" type="text/css" rel="stylesheet"
    href="node_modules/datatables.net-buttons-dt/css/buttons.dataTables.min.css">
    <link media="all" type="text/css" rel="stylesheet"
    href="node_modules/angular-datatables/dist/css/angular-datatables.min.css">
    <link media="all" type="text/css" rel="stylesheet" href="node_modules/jquery-ui-dist/jquery-ui.min.css">
    
    <style>
        .page {
            margin: 10px;
        }
        
        td {
            padding-right: 15px;
            padding-bottom: 10px;
        }
        
        .tables {
            width: 100%;
            table-layout: fixed;
        }
        
        .tables thead>tr>th {
            padding-right: 5px;
            vertical-align: bottom;
            border-bottom: 2px solid #ddd;
        }
        
        .tables tbody {
            display: table-row-group;
            vertical-align: middle;
        }
        
        .tables tbody>tr>td {
            line-height: 1.42857143;
            vertical-align: middle;
            border-top: 1px solid #ddd;
            font-size: 15px;
            overflow: auto;
        }
        
        .btn.btn-primary {
            z-index: 1;
            background-color: #9d9d9d;
        }
        
        .btn.btn-primary:hover,
        .btn.btn-primary.active {
            z-index: 1;
            background-color: #337ab7
        }
        
        .items,
        .items td,
        .items tr,
        .items th {
            border-collapse: collapse;
            border: 1px solid black;
            text-align: left;
            --box-sizing: border-box !important;
            --table-layout: fixed;
            overflow-wrap: break-word;
        }
        
        .items tr:nth-child(even) {
            background-color: #f1f1f1;
        }
        
        .items th {
            background-color: #98FB98
        }
        
        /*remove date and title on top of printed pages*/
        /*@page {
            size: auto;
            margin-top: 0mm;
        }*/
        
        /*repeat table headers on each page*/
        @media print {
            thead {
                display: table-header-group;
            }
        }
        </style>
</head>

<body ng-app="myApp">
    <center>
        <table border=0 class="table" style="width: 100%">
            <tr>
                <td align="center" valign="center"></td>
                <td width="15%">
                    <div style="text-align: center; font-size: 1em; font-weight: bold;">{ENTER YOUR PRODUCT LOGO}</div>
                </td>
                <td align="center" valign="center">
                    <center>
                        <h2 align="center" style="margin-left:10%; margin-right:15%; color: rgb(111,84,153); font-size: 32px"><b>Chemotherapy Durations Report</b><br></h2>
                    </center>
                </td>
                <td width="15%"><a href="VirtualWaitingRoom/AboutOpal.html"><h2 style="color: rgb(111,84,153); font-size: 40px"><b><u>About Opal</u></b></h2></td>
                <td align="center" valign="bottom"></td>
            </tr>
        </table>
    </center>    

    <div class="page" ng-controller="main">
        <table border="0" width="50%" padding="5">
            <tr>
                <td valign="top"><b>Description:</b></td>
                <td>Report to calculate the room occupation time for chemotherapy treatments in the date range. For each
                    treatment, the report finds the time spent inside the first "TX AREA" room of the day.</td>
            </tr>
        </table>
        <br>

        <form ng-submit="runScript()">
            <table border="0" style="width:50%;" padding="2">
                <tr bgcolor=#1D0886 fgcolor=#FFFFFF>
                    <th colspan=5 width="20%" align="left">
                        <font color=#FFFFFF>Selection Criteria</font>
                    </th>
                </tr>
                <tr>
                    <td><br></td>
                </tr>

                <tr>
                    <td><b>From Date: </b></td>
                    <td><input type="date" ng-model="sDate" required></td>
                    <td><b>To Date: </b></td>
                    <td><input type="date" ng-model="eDate" required></td>
                </tr>

                <tr>
                    <td><br></td>
                </tr>
                <tr>
                    <td></td>
                    <td><button type="submit">Submit</button></td>
                </tr>

            </table>
        </form>

        <p>{{message}}</p>
        <div ng-if='showDiv'>
            <table>
                <tr>
                    <td><b>Current Date: </b></td>
                    <td>{{today | date}}</td>
                </tr>
                <tr>
                    <td><b>Search Date: </b></td>
                    <td>{{sDateDisplay | date}} - {{eDateDisplay |date}} </td>
                </tr>
            </table>

            <br>

            <h1>Chemotherapy Treatment Duration</h1>
            <table class='items' datatable="ng" dt-options="dtOptions">
                <thead>
                    <tr>
                        <th>Last Name</th>
                        <th>First Name</th>
                        <th>Mrn</th>
                        <th>Site</th>
                        <th>Clinic Code</th>
                        <th>Clinic</th>
                        <th>Appointment Code</th>
                        <th>Appointment Status</th>
                        <th>Scheduled Date</th>
                        <th>Room</th>
                        <th>Arrival</th>
                        <th>Discharge</th>
                        <th>Treatment Duration</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="row in tableData">
                        <td>{{row.LastName}}</td>
                        <td>{{row.FirstName}}</td>
                        <td>{{row.Mrn}}</td>
                        <td>{{row.Site}}</td>
                        <td>{{row.ResourceCode}}</td>
                        <td>{{row.ResourceName}}</td>
                        <td>{{row.AppointmentCode}}</td>
                        <td>{{row.Status}}</td>
                        <td>{{row.ScheduledDateTime}}</td>
                        <td>{{row.CheckinVenueName}}</td>
                        <td>{{row.ArrivalDateTime}}</td>
                        <td>{{row.DichargeThisLocationDateTime}}</td>
                        <td>{{row.Duration}}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        var app = angular.module('myApp', ['datatables', 'datatables.buttons', 'ui.bootstrap', 'jlareau.bowser']);
        app.controller('main', function ($scope, $filter, DTOptionsBuilder, callScript, bowser) {
            $scope.chromeDetected = bowser.name == 'Chrome' ? 1 : 0;
            if (!$scope.chromeDetected) { $('[type="date"]').datepicker({ dateFormat: 'yy-mm-dd' }); }

            $scope.today = new Date();
            $scope.sDate = new Date();
            $scope.eDate = new Date();

            //add datatables settings
            $scope.dtOptions = DTOptionsBuilder.newOptions();
            $scope.dtOptions.withOption('lengthMenu', [[25, 50, 100, -1], [25, 50, 100, 'All']]);
            $scope.addPrintButton = function () {
                $scope.dtOptions.withButtons(
                    [
                        'csvHtml5',
                        {
                            extend: 'print',
                            title: 'Room Usage',
                            exportOptions: {
                                stripHtml: false
                            },
                            customize: function (win) {
                                $(win.document.body)
                                    //.css( 'font-size', '15pt' )
                                    .prepend(
                                        '<table style="font-size:20px">' +
                                        '<tr>' +
                                        '<td><b>Current Date: </b></td><td>' + $filter('date')($scope.today) + '</td>' +
                                        '</tr>' +
                                        '<tr>' +
                                        '<td><b>Search Date: </b></td><td>' + $filter('date')($scope.sDateDisplay) + ' - ' + $filter('date')($scope.eDateDisplay) + '</td>' +
                                        '</tr>' +
                                        '</table>'
                                    );

                                //$(win.document).find('table').addClass('test').css('font-size','20pt');
                            }
                        }
                    ]);
            }

            $scope.convertDate = function (enteredDate) {
                var year = enteredDate.getFullYear();
                var month = enteredDate.getMonth() + 1 >= 10 ? enteredDate.getMonth() + 1 : "0" + (enteredDate.getMonth() + 1);
                var day = enteredDate.getDate() >= 10 ? enteredDate.getDate() : "0" + enteredDate.getDate()
                var convDate = year + "-" + month + "-" + day;

                return convDate;
            }

            //these functions will ensure that a button always stays checked so that a query doesn't return an empty list

            $scope.runScript = function () {
                $scope.sDateDisplay = $scope.sDate;
                $scope.eDateDisplay = $scope.eDate;

                $scope.showDiv = false;
                $scope.message = "Getting Data...";

                callScript.getData($scope.convertDate($scope.sDate), $scope.convertDate($scope.eDate)).then(function (response) {
                    $scope.tableData = response;

                    $scope.message = "";
                    $scope.showDiv = true;

                    $scope.addPrintButton();
                });
            }
        });

        app.factory('callScript', function ($http, $q) {
            return {
                getData: function (sDate, eDate) {
                    var defer = $q.defer();

                    url = "php/report/chemoDurations?"

                    $http.get(url + "sDate=" + sDate + "&eDate=" + eDate).then(function (response) {
                        var info = {};
                        info = response.data;
                        defer.resolve(info);
                    });
                    return defer.promise;
                }
            };
        });
    </script>

    <br>
    <hr>
    <center> Problems and bug reports to <a href="mailto: {SUPPORT_EMAIL_ADDRESS}">{SUPPORT_EMAIL_ADDRESS}</a></center>
</body>

</html>