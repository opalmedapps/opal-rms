<html>
<title>Patient Locations</title>
<img src='../../images/logo.png'>
<body ng-app="myApp">
<script src="../node_modules/jquery/dist/jquery.min.js"></script>
<script src="../node_modules/jquery-ui-dist/jquery-ui.min.js"></script>
<script src="../node_modules/angular/angular.min.js"></script>
<script src="../node_modules/angular-animate/angular-animate.min.js"></script>
<script src="../node_modules/ui-bootstrap4/dist//ui-bootstrap-tpls.js"></script>
<script src="../node_modules/highcharts/highcharts.js"></script>
<script src="../node_modules/highcharts-ng/dist/highcharts-ng.min.js"></script>
<script src="../node_modules/angular-bowser/src/angular-bowser.js"></script>
<script src="/node_modules/angular-cookies/angular-cookies.min.js"></script>

<link media="all" type="text/css" rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
<link media="all" type="text/css" rel="stylesheet" href="../node_modules/jquery-ui-dist/jquery-ui.min.css">

<style>
	.items,
	.items td,
	.items tr,
	.items th {
		border-collapse:collapse;
		border:1px solid black;
		text-align:left;
	}

	.items tr:nth-child(even){background-color:#f1f1f1;min-width:50px;}
	.items th {background-color:#98FB98;min-width:50px}
	.page {margin:10px;}
	td {padding-right: 15px;}

	.match {
		background-color:#75ea28;
	}

	.tables {
		width:100%;
		table-layout: fixed;
	}
	.tables thead>tr>th {
		padding-right: 5px;
		vertical-align: bottom;
		border-bottom: 2px solid #ddd;
	}
	.tables tbody {
		display: table-row-group;
		vertical-align: middle;
	}
	.tables tbody>tr>td {
		line-height: 1.42857143;
		vertical-align: middle;
		border-top: 1px solid #ddd;
		font-size: 15px;
		overflow: auto;
	}
</style>

<div class="page" ng-controller="main" ng-init="runScript(true)">
	<center><h1>{{header}}</h1></center><center><h2><u>Patient Locations</u></h2></center>
	<table border="0" width="50%" padding="5">
		<tr>
		<td valign="top"><b>Description:</b></td>
		<td>Report that creates a timeline of patient checkins/checkouts for a specified day.</td>
		</tr>
	</table>
	<br>

	<form ng-submit="runScript()">
		<table border="0" width="50%" padding="2">
			<tr bgcolor=#1D0886 fgcolor=#FFFFFF>
			<th colspan=5 width="20%" align="left"><font color=#FFFFFF>Selection Criteria</font></th>
			</tr>
			<tr><td><br></td></tr>

			<tr>
			<td><b>From Date: </b></td>
			<td><input  type="date" ng-model="sDate" required></input></td>
			<td><b>To Date: </b></td>
			<td><input type="date" ng-model="eDate" required></input></td>
			</tr>

			<tr>
			<td><b>Filter for a specific appointment code: </b></td>
			<td><input type="text" ng-model="filter"></input></td>
			</tr>

			<tr><td><br></td></tr>
			<tr>
			<td></td>
			<td align="right"><input type="submit" value="Submit"> <input type="reset">
			</td>
			</tr>
		</table>
	</form>

	<p>{{message}}</p>
	<div ng-if='showDiv'>
		<table>
			<tr><td>Searching From: </td><td>{{sDateDisplay | date}}</td></tr>
			<tr><td>Searching To: </td><td>{{eDateDisplay | date}}</td></tr>
		</table>
		<br>

		<div ng-repeat="(date,patData) in patData">
			<highchart ng-show="showChart[date]" config="configs[date]"></highchart>
			<br>
		<div>
	</div>

	<script type="text/ng-template" id="appointment.htm">
		<div class="modal-header">
			<h2 class="modal-title">{{selectedAppointment.fname}}, {{selectedAppointment.lname}}'s Timeline</h2>
		</div>

		<div class="modal-body">
			<p><b>Patient ID: </b>{{selectedAppointment.pID}}</p>
			<p><b>Appointment Name: </b>{{selectedAppointment.app}}</p>
			<p><b>Appointment Code: </b>{{selectedAppointment.code}}</p>
			<p><b>Scheduled Start: </b>{{selectedAppointment.time}}</p>
			<p><b>Status: </b>{{selectedAppointment.status}}</p>
			<br>
			<div style="padding-bottom: 20px; border-bottom: 1px solid #e5e5e5">
				<div class="row">
					<div class="col-md-12">
						<table class="tables">
						<thead>
							<tr>
							<th>Room</th>
							<th>Checkin Time</th>
							<th>Checkout Time</th>
							<th>Time Spent Inside (Hours)</th>
							</tr>
						</thead>
						<tbody>
							<tr ng-repeat="sa in selectedAppointment.data">
							<td>{{sa[0]}}</td>
							<td>{{sa[1]}}</td>
							<td>{{sa[2]}}</td>
							<td>{{sa[3]}}</td>
							</tr>
						</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</script>

</div>

<script>
var app = angular.module('myApp',['ui.bootstrap','ngAnimate','highcharts-ng','jlareau.bowser','ngCookies']).config(['$qProvider', function ($qProvider) {
    $qProvider.errorOnUnhandledRejections(false);
}]);

app.controller('main', function($scope,$uibModal,$cookies,callScript,bowser)
{
	$scope.chromeDetected = bowser.name == 'Chrome' ? 1:0;
	if(!$scope.chromeDetected) {$('[type="date"]').datepicker({dateFormat: 'yy-mm-dd'});}

	$scope.showDiv = false;
	$scope.configs = {};
	$scope.showChart = {};

	$scope.filter = '';

	var speciality = $cookies.get("speciality");

	if(speciality === 'onc') {$scope.header = "MUHC Department of Radiation Oncology";}
	else if(speciality === 'ortho') {$scope.header = "MGH Department of Orthopedics";}

	$scope.convertDate = function (enteredDate)
	{
		var year = enteredDate.getFullYear();
		var month = enteredDate.getMonth()+1 >= 10 ? enteredDate.getMonth()+1 : "0" + (enteredDate.getMonth()+1);
		var day = enteredDate.getDate() >= 10 ? enteredDate.getDate() : "0" + enteredDate.getDate()
		var convDate = year + "-" + month + "-" + day;

		return convDate;
	}

	$scope.convertNumToTime = function (num)
	{
		var minutes = parseInt((num - parseInt(num))*60);
		minutes = minutes >= 10 ? minutes : "0"+minutes
		var hours =  parseInt(num) >= 10 ? parseInt(num) : "0"+parseInt(num);

		return hours+":"+minutes;
	}

	$scope.createChart = function (day,data)
	{
		var categoryArr = [];
		var dataArr = [];
		var currentX = 0;

		//loop for each appointment in the day
		angular.forEach(data, function (pData,index)
		{
			//determine what color the label should be and append it to the label text
			var color = 'red';
			if(pData.status == 'Completed') {color = 'green';}
			else if(pData.status == 'Open') {color = 'blue';}
			else if(pData.status == 'In Progress') {color = '#dd18ff';} //purple

			categoryArr.push('<div style="color:'+color+';">'+pData.pID+'</div>#-#<div style="color:'+color+';">'+pData.app+'</div>#-#<div style="color:'+color+';">'+pData.code+'</div>');

			//add a black border for each column, except if it is the not checked in column
			angular.forEach(pData.chartData.reverse(), function(values,ind)
			{
				var bordCol = 'black';
				if(ind == pData.chartData.length -1) {bordCol = '';}

				dataArr.push({data:[{x:currentX,y:values[0]}],color:values[1],borderColor:bordCol,name:values[2],showInLegend:false});
			});
			currentX++;
		});

		//insert points with no coordinates so that they appear in the legend
		dataArr.push({name:'EXAM ROOM',color:'#ff0000'});
		dataArr.push({name:'Cast Room',color:'#0099ff'});
		dataArr.push({name:'Ortho Waiting Room',color:'#99d6ff'});
		dataArr.push({name:'Ortho Room',color:'#0066ff'});
		dataArr.push({name:'TX AREA',color:'#ffff00'});
		dataArr.push({name:'RC Waiting Room',color:'#66ff33'});
		dataArr.push({name:'S1 Waiting Room',color:'#cc99ff'});
		dataArr.push({name:'SENT FOR X-RAY',color:'#996633'});
		dataArr.push({name:'SENT FOR PHYSIO',color:'#ff9933'});
		dataArr.push({name:'TEST CENTRE WAITING ROOM',color:'#cc00ff'});
		dataArr.push({name:'VISIT COMPLETE',color:'#000000'});
		dataArr.push({name:'The Blank Room',color:'#ffffff'});
		dataArr.push({name:'BACK FROM X-RAY/PHYSIO',color:'#ff33cc'});
		dataArr.push({name:'Ortho Treatment Room',color:'#000099'});
		dataArr.push({name:'Other',color:'#e6e6e6'});

		//set up the highcharts object for that day
		$scope.configs[day] =
		{
			chart: {type:'bar',height:(75*data.length > 500 ? 75*data.length : 500),width:1800,
				events: {click: function (ev) {$scope.displayAppointments($scope.patData[day][Math.floor(ev.xAxis[0].value+0.5)]);}}},
			title: {text:'Patients with appointments on ' + day,},
			xAxis: {
				categories: categoryArr,
				title:{text:'Patient ID',align:'high'},
				labels: {
					step:1,
					formatter: function () {
						return this.value.replace(/#-#/g,'<br>');
					}
				},
				gridLineColor: 'black',
        			gridLineWidth: 1,
				gridLineDashStyle: 'longdash'
			},
			yAxis: {
				min:6,
				max:24,
				tickInterval:1,
				title:{text:'Time (Hours)'},
				opposite:true
			},
			plotOptions:{
				series:{stacking:'normal',
				events: {
					click: function (ev) {$scope.displayAppointments($scope.patData[day][this.processedXData[0]]);},
					legendItemClick: function() {return false;}
				},
				dataLabels:{enabled:true,crop:false,overflow:'none',inside:false,
					style: {"color":"black"},
					allowOverlap: true,
					formatter:function()
					{
						if(this.series.name.indexOf('Current') == 0) {return this.series.name;}
						return "";
					}}}},
			legend: {verticalAlign: 'top',y:25},
			series: dataArr,
			tooltip: {formatter: function()
				{
					if(this.series.name == 'Not Checked In') {return "Checked in at "+$scope.convertNumToTime(this.series.dataMax);}
					else if(this.series.name.indexOf('Current') == 0) {return "Checked in "+this.series.name.substring(9) + " at "+$scope.convertNumToTime(this.series.dataMax-this.y);}
					else {return this.series.name+"<br>Checked in at "+$scope.convertNumToTime(this.series.dataMax-this.y)+"<br>Checked out at "+$scope.convertNumToTime(this.series.dataMax);}
				}}
		};
		$scope.showChart[day] = true;
	}

	$scope.runScript = function (firstTime)
	{
		if(firstTime)
		{
			$scope.sDate = new Date();
			$scope.eDate = new Date();
		}

		$scope.sDateDisplay = $scope.sDate;
		$scope.eDateDisplay = $scope.eDate;

		$scope.showDiv = false;
		$scope.message = "Getting Data...";
		callScript.getData($scope.convertDate($scope.sDate),$scope.convertDate($scope.eDate),speciality,$scope.filter).then(function (response)
		{
			$scope.patData = response;

			angular.forEach($scope.patData, function(val,key)
			{
				$scope.createChart(key,val);
			});

			$scope.message = "";
			$scope.showDiv = true;
		});
	}

	$scope.displayAppointments = function (timeline)
	{
		var selectedAppointment = {
			fname: timeline.fname,
			lname: timeline.lname,
			pID: timeline.pID,
			app: timeline.app,
			code: timeline.code,
			status: timeline.status,
			time: timeline.time,
			data: timeline.data
		};

		//due to a bug, closing the modal scrolls the page to the top if data is fetched more than once
		//so we save the position of the user and return them to this position manually after the modal is closed
		var scrollPosition = $(window).scrollTop();

		// Open up a modal instance to display patients
		var modalInstance = $uibModal.open({
			templateUrl: 'appointment.htm',
			controller: AppointmentsModalInstanceCtrl,
			resolve: {selectedAppointment: function () {return selectedAppointment;}},
			windowClass: 'membersModal',
			size: 'lg'
		}).closed.then(function () {
			window.scrollTo(0,scrollPosition);
		});
	}

	var AppointmentsModalInstanceCtrl = function($scope,$uibModalInstance,selectedAppointment)
	{
		$scope.selectedAppointment = selectedAppointment;
	}

});

app.factory('callScript',function($http,$q)
{
	return {
		getData: function(sDate,eDate,speciality,filter)
		{
			var defer = $q.defer();

			url = "./Scripts/PatientLocations?"

			$http.get(url+"&sDate="+sDate+"&eDate="+eDate+"&clinic="+speciality+"&filter="+filter).then(function (response)
			{
				var info = {};
				info = response.data;
				defer.resolve(info);
			});
			return defer.promise;
		}
	};
});
</script>

<br>
<hr>
<center> Problems and bug reports to John Kildea<br> (jkildea@medphys.mcgill.ca)</center>
</body>
</html>
