<html>

<head>
    <title>Waiting Times Distribution Report</title>
    <base href="/orms/">
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="node_modules/jquery-ui-dist/jquery-ui.min.js"></script>
    <script src="node_modules/angular/angular.min.js"></script>
    <script src="node_modules/angular-animate/angular-animate.min.js"></script>
    <script src="node_modules/ui-bootstrap4/dist/ui-bootstrap-tpls.js"></script>
    <script src="node_modules/highcharts/highcharts.js"></script>
    <script src="node_modules/highcharts-ng/dist/highcharts-ng.min.js"></script>
    <script src="node_modules/angular-bowser/src/angular-bowser.js"></script>
    <script src="node_modules/angular-cookies/angular-cookies.min.js"></script>
    <script src="VirtualWaitingRoom/js/config.js"></script>

    <link media="all" type="text/css" rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link media="all" type="text/css" rel="stylesheet" href="node_modules/jquery-ui-dist/jquery-ui.min.css">

    <style>
        .page {
            margin: 10px;
        }

        td {
            padding-right: 15px;
        }

        .tables {
            width: 100%;
            table-layout: fixed;
        }

        .tables thead>tr>th {
            padding-right: 5px;
            vertical-align: bottom;
            border-bottom: 2px solid #ddd;
        }

        .tables tbody {
            display: table-row-group;
            vertical-align: middle;
        }

        .tables tbody>tr>td {
            line-height: 1.42857143;
            vertical-align: middle;
            border-top: 1px solid #ddd;
            font-size: 15px;
            overflow: auto;
        }
    </style>
</head>

<body ng-app="myApp" ng-controller="main">
    <center>
        <table border=0 class="table" style="width: 100%">
            <tr>
                <td align="center" valign="center"></td>
                <td width="15%"><img src="{{rmsLogo}}" width="100%"></td>
                <td align="center" valign="center">
                    <center>
                        <h2 align="center" style="margin-left:10%; margin-right:15%; color: rgb(111,84,153); font-size: 32px"><b>Waiting Times Distribution Report</b><br></h2>
                    </center>
                </td>
                <td width="15%"><a href="VirtualWaitingRoom/AboutOpal.html"><h2 style="color: rgb(111,84,153); font-size: 40px"><b><u>About Opal</u></b></h2></td>
                <td align="center" valign="bottom"></td>
            </tr>
        </table>
    </center>    

    <div class="page">
        <table border="0" width="50%" padding="5">
            <tr>
                <td valign="top"><b>Description:</b></td>
                <td>Report to find the waiting times of patients for each doctor and clinic based on patient checkin
                    time.</td>
            </tr>
        </table>
        <br>

        <form ng-submit="runScript()">
            <table border="0" width="50%" padding="2">
                <tr bgcolor=#1D0886 fgcolor=#FFFFFF>
                    <th colspan=5 width="20%" align="left">
                        <font color=#FFFFFF>Selection Criteria</font>
                    </th>
                </tr>
                <tr>
                    <td><br></td>
                </tr>

                <tr>
                    <td><b>From Date: </b></td>
                    <td><input type="date" ng-model="sDate" required></input></td>
                    <td><b>To Date: </b></td>
                    <td><input type="date" ng-model="eDate" required></input></td>
                </tr>

                <tr>
                    <td><br></td>
                </tr>
                <tr>
                    <td></td>
                    <td align="right"><input type="submit" value="Submit"> <input type="reset">
                    </td>
                </tr>
            </table>
        </form>

        <p>{{message}}</p>
        <div ng-if='showDiv'>
            <table>
                <tr>
                    <td>Searching From: </td>
                    <td>{{sDateDisplay | date}}</td>
                </tr>
                <tr>
                    <td>Searching To: </td>
                    <td>{{eDateDisplay | date}}</td>
                </tr>
                <tr>
                    <td>Note:</td>
                    <td>A patient's waiting time is capped at 8 to 8.5 hours in the histograms.</td>
                </tr>
            </table>
            <br>

            <h1>Waiting Time of Patients for Each Doctor/Clinic</h1>
            <p>Find Chart: <select ng-model="selectedChart" ng-options="key as data.name for (key,data) in chartData"
                    ng-change="selectChart(selectedChart)">
                    <option ng-model="selectedChart" value=''>All</option>
                </select></p>

            <div ng-show="showDiv" ng-repeat="(key,data) in chartData">
                <p>Mean: {{data.mean/3600 | number: 2}} STD: {{data.std/3600| number: 2}}</p>
                <highchart ng-show="showChart[key]" config="configs[key]"></highchart>
            </div>

            <script type="text/ng-template" id="patients.htm">
        <div class="modal-header">
            <h2 class="modal-title">Patient Waiting Time List</h2>
        </div>

        <div class="modal-body">
            <div style="padding-bottom: 20px; border-bottom: 1px solid #e5e5e5">
                <div class="row">
                    <div class="col-md-12">
                        <table class="tables">
                        <thead>
                            <tr>
                            <th>Patient</th>
                            <th>Waiting Room</th>
                            <th>Date</th>
                            <th>Interval</th>
                            <th>Time Spent Waiting (Hours)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="sp in selectedPatients">
                            <td>{{sp.lname}}, {{sp.fname}} ({{sp.mrn +"-"+ sp.site}})</td>
                            <td>{{sp.room}}</td>
                            <td>{{sp.day}}</td>
                            <td>{{sp.waitPeriod}}</td>
                            <td>{{sp.waitTime/3600 | number: 1}}</td>
                            </tr>
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </script>
        </div>

        <script>
            var app = angular.module('myApp', ['ui.bootstrap', 'ngAnimate', 'highcharts-ng', 'jlareau.bowser', 'ngCookies', 'vwr.config']).config(['$qProvider', function ($qProvider) {
                $qProvider.errorOnUnhandledRejections(false);
            }]);

            app.controller('main', function ($scope, $uibModal, $cookies, callScript, bowser, CONFIG) {
                $scope.chromeDetected = bowser.name == 'Chrome' ? 1 : 0;
                if (!$scope.chromeDetected) { $('[type="date"]').datepicker({ dateFormat: 'yy-mm-dd' }); }

                $scope.showDiv = false;
                $scope.configs = {};
                $scope.showChart = {};
                $scope.sDate = new Date();
                $scope.eDate = new Date();

                $scope.rmsLogo = CONFIG.BRANDING_RMS_LOGO_PATH;
                $scope.supportEmail = CONFIG.BRANDING_SUPPORT_EMAIL_ADDRESS;

                var speciality = $cookies.get("specialityGroupId");;

                $scope.convertDate = function (enteredDate) {
                    var year = enteredDate.getFullYear();
                    var month = enteredDate.getMonth() + 1 >= 10 ? enteredDate.getMonth() + 1 : "0" + (enteredDate.getMonth() + 1);
                    var day = enteredDate.getDate() >= 10 ? enteredDate.getDate() : "0" + enteredDate.getDate()
                    var convDate = year + "-" + month + "-" + day;

                    return convDate;
                }

                $scope.createCharts = function (resource) {
                    $scope.showChart[resource] = true;
                    $scope.configs[resource] =
                    {
                        chart: { type: 'column', width: 1000 },
                        title: { text: $scope.chartData[resource].name },
                        xAxis: { min: 0, max: 8.5, type: 'linear', tickInterval: 0.5, title: { text: 'Wait Time (Hours)', align: 'high' } },
                        yAxis: { min: 0, tickInterval: 1, title: { text: 'Number of Patients', align: 'high' } },
                        plotOptions: {
                            series: {
                                pointPadding: 0, groupPadding: 0, pointPlacement: +0.5, cursor: 'pointer',
                                point: {
                                    events: {
                                        click: function () { $scope.displayPatients($scope.chartData[resource].patientData, this.x); }
                                    }
                                }
                            }
                        },
                        series: [{ showInLegend: false, pointRange: 0.5, data: $scope.chartData[resource].graphData }]
                    };
                }

                $scope.runScript = function () {
                    $scope.sDateDisplay = $scope.sDate;
                    $scope.eDateDisplay = $scope.eDate;

                    $scope.showDiv = false;
                    $scope.message = "Getting Data...";
                    callScript.getData($scope.convertDate($scope.sDate), $scope.convertDate($scope.eDate), speciality).then(function (response) {
                        $scope.chartData = response;

                        angular.forEach($scope.chartData, function (val, key) {
                            $scope.createCharts(key);
                        });
                        $scope.message = "";
                        $scope.showDiv = true;
                    });
                }

                $scope.selectChart = function (selectedChart) {
                    if (!selectedChart) { angular.forEach($scope.showChart, function (val, key) { $scope.showChart[key] = true; }); }
                    else {
                        angular.forEach($scope.showChart, function (val, key) { $scope.showChart[key] = false; });
                        $scope.showChart[selectedChart] = true;
                    }
                }

                $scope.displayPatients = function (patients, category) {
                    var selectedPatients = [];
                    angular.forEach(patients, function (pat) {
                        if (pat.waitTime < (category + 0.5) * 3600 && pat.waitTime >= category * 3600) { selectedPatients.push(pat); }
                    });

                    // Open up a modal instance to display patients
                    var modalInstance = $uibModal.open({
                        templateUrl: 'patients.htm',
                        controller: PatientsModalInstanceCtrl,
                        resolve: { selectedPatients: function () { return selectedPatients; } },
                        windowClass: 'membersModal',
                        size: 'lg'
                    });
                }

                var PatientsModalInstanceCtrl = function ($scope, $uibModalInstance, selectedPatients) {
                    $scope.selectedPatients = selectedPatients;
                }


            });

            app.factory('callScript', function ($http, $q) {
                return {
                    getData: function (sDate, eDate, speciality) {
                        var defer = $q.defer();

                        url = "php/report/waitingDistribution?"

                        $http.get(url + "speciality=" + speciality + "&sDate=" + sDate + "&eDate=" + eDate).then(function (response) {
                            var info = {};
                            info = response.data;
                            defer.resolve(info);
                        });
                        return defer.promise;
                    }
                };
            });
        </script>

        <br>
        <hr>
        <center> Problems and bug reports to <a href="mailto: {{supportEmail}}">{{supportEmail}}</a></center>
</body>

</html>
